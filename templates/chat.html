{% extends 'flatpages/default.html' %}

{% block title %}
    Чат
{% endblock %}

{% block css %}
    {% load static %}
    <link href="{% static "styles/chat.css"%}" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
        <div class="chat">
            <div class="chat-header py-3 px-4 border-bottom" id="chat-header">
            </div>
            <div class="chat-log">
            </div>
            <div class="flex-grow-0 py-3 px-4 border-top chat-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="chat-message-input" placeholder="Введите ваше сообщение">
                    <button class="btn btn-primary" id="chat-message-submit">Отправить</button>
                </div>
            </div>
        </div>
{% endblock %}

{% block script %}
    {% load static %}
    <script src=" {% static 'reconnecting-websocket.js' %}"></script>
    <script>
        const user = {{ user }}
        const chat_id = {{ room_id }}
        
        fetch(`${window.location.origin}/api/v1${window.location.pathname}`)
            .then((response) => {
                const result = response.json();
                return result
            })
            .then((data) => {
                if (data.type === "PR") {
                    for (let listUser of data.users) {
                        if (listUser.user.username !== user.username) {
                            chatHeader(listUser.avatar, listUser.user.username)
                        }
                    }
                } else {
                    chatHeader(data.avatar, data.name)
                }
            })
        
        function chatHeader (avatar, username) {
            const headerTag = document.createElement('div')
            const imgTag = document.createElement('img')
            const usernameTag = document.createElement('div')
            usernameTag.textContent = username
            usernameTag.className = 'interlocutor-username'
            imgTag.src = avatar
            imgTag.className = 'interlocutor-avatar'
            headerTag.appendChild(imgTag)
            headerTag.appendChild(usernameTag)
            headerTag.className = 'interlocutor'
            document.querySelector('#chat-header').appendChild(headerTag)
        }
        
        function fetchMessages() {
            chatSocket.send(JSON.stringify({'command': 'fetch_messages' }));
        }
        
        function createMessage(data) {
            const messageTag = document.createElement('div')
            const imgTag = document.createElement('img')
            const messageMainTag = document.createElement('div')
            const messageInfoTag = document.createElement('div')
            const userTag = document.createElement('div')
            const dateTag = document.createElement('div')
            const contentTag = document.createElement('div')
            contentTag.textContent = data.content
            contentTag.className = 'message-content'
            dateTag.textContent = data.timestamp
            dateTag.className = 'message-date'
            userTag.textContent = data.user.username
            userTag.className = 'message-username'
            messageInfoTag.appendChild(userTag)
            messageInfoTag.appendChild(dateTag)
            messageInfoTag.className = 'message-info'
            messageMainTag.appendChild(messageInfoTag)
            messageMainTag.appendChild(contentTag)
            messageMainTag.className = 'message-main'
            imgTag.src = data.user.avatar
            imgTag.className = 'message-avatar'
            messageTag.appendChild(imgTag)
            messageTag.appendChild(messageMainTag)
            if (data.user.username === user.username) {
                messageTag.className = 'send'
            } else {
                messageTag.className = 'reply'
            }
            const chat = document.querySelector('.chat-log');
            chat.appendChild(messageTag);
            chat.scrollTop = chat.scrollHeight;
            

        }
        
        const chatSocket = new ReconnectingWebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + chat_id + '/');
        
        chatSocket.onopen = function(e) {
            fetchMessages();
        }

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data['command'] === 'messages') {
                for (let message of data['messages']) {
                    createMessage(message);
                }
            } else if (data['command'] === 'new_message'){
                createMessage(data['message']);
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
        
        document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.getElementById('chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'command': 'new_message',
            'message': message,
            'from': user.username
        }));

        messageInputDom.value = '';
    }

    </script>
{% endblock%}
